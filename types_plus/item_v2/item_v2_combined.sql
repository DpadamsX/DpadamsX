-- Create a view onto item formatted as item_v2.-- If item changes, you can update the view to handle the modification smoothly.-- Note: This view is automatically a custom type, with an array type to match. See types_plus.insert_item_v2.DROP VIEW IF EXISTS types_plus.item_v2 CASCADE;-- Careful!CREATE OR REPLACE VIEW types_plus.item_v2 AS select id,        item_arch_id,        facility_specialty_id,        item_uu_id_across_item_archs,        inv_responsible_user_id,        facility_department_id,        specialty_id,        sup_id,        dr_people_id,        item_type_id,        item_master_link_id,        facility_location_id,        clinic_id,        hsys_tag_id,        name_copied_from_prod_id,        created_dts,        updated_dts,        named_dts,        needs_sched_sync_as_of_dts,        weight_lb,        qty,        flow,        flow_long,        max_processed_one_day,        par,        assembly_difficulty,        num_inst,        repair_every_x,        their_qty,        replace_every_x_cycles,        hide_specialty_in_name,        marked_for_deletion,        is_assembly_critical,        requires_leak_test,        is_not_tracked_by_inv_no,        is_imlink_locked,        is_robotic,        is_flexible_scope,        is_generic_pack,        dont_print_count_sheet,        is_conflict_check,        is_small_set,        hide_hsys_tag_in_name,        is_name_finalized,        is_in_data_cleanse_scope,        is_label_abbr,        has_implants,        sync_to_other_software_systems,        inv_has_implants,        is_custom_sort,        is_name_copied_from_prod,        is_deactivated,        is_vendor_data,        name_needs_review,        ignore_for_optimization,        inv_status,        their_name,        opt_status,        created_by,        updated_by,        old_names,        their_serial_no,        name_desc,        name_,        their_id,        decon_special_instructions,        named_by,        needs_review_notes,        vendor_tray_type,        sterilization_method,        priority,        category,        packaging_type,        packaging_notes,        their_packaging_type,        assembly_special_instructions,        sterilize_special_instructions,        label_name_abbr,        their_location,        count_sheet_status,        requested_by,        rack_row_bin_note,        standardization_status,        repair_every_x_type,        their_base_barcode,        their_key,        stuff   from item;ALTER TABLE types_plus.item_v2    OWNER TO user_change_structure;-- Create a casting function to convert item rows into the compound type format item_v2.-- If item changes, you can update the casting to handle the modification smoothly.CREATE OR REPLACE FUNCTION types_plus.item_to_v2 (item_in item)  RETURNS item_v2AS $BODY$                   SELECT			item_in.id,			item_in.item_arch_id,			item_in.facility_specialty_id,			item_in.item_uu_id_across_item_archs,			item_in.inv_responsible_user_id,			item_in.facility_department_id,			item_in.specialty_id,			item_in.sup_id,			item_in.dr_people_id,			item_in.item_type_id,			item_in.item_master_link_id,			item_in.facility_location_id,			item_in.clinic_id,			item_in.hsys_tag_id,			item_in.name_copied_from_prod_id,			item_in.created_dts,			item_in.updated_dts,			item_in.named_dts,			item_in.needs_sched_sync_as_of_dts,			item_in.weight_lb,			item_in.qty,			item_in.flow,			item_in.flow_long,			item_in.max_processed_one_day,			item_in.par,			item_in.assembly_difficulty,			item_in.num_inst,			item_in.repair_every_x,			item_in.their_qty,			item_in.replace_every_x_cycles,			item_in.hide_specialty_in_name,			item_in.marked_for_deletion,			item_in.is_assembly_critical,			item_in.requires_leak_test,			item_in.is_not_tracked_by_inv_no,			item_in.is_imlink_locked,			item_in.is_robotic,			item_in.is_flexible_scope,			item_in.is_generic_pack,			item_in.dont_print_count_sheet,			item_in.is_conflict_check,			item_in.is_small_set,			item_in.hide_hsys_tag_in_name,			item_in.is_name_finalized,			item_in.is_in_data_cleanse_scope,			item_in.is_label_abbr,			item_in.has_implants,			item_in.sync_to_other_software_systems,			item_in.inv_has_implants,			item_in.is_custom_sort,			item_in.is_name_copied_from_prod,			item_in.is_deactivated,			item_in.is_vendor_data,			item_in.name_needs_review,			item_in.ignore_for_optimization,			item_in.inv_status,			item_in.their_name,			item_in.opt_status,			item_in.created_by,			item_in.updated_by,			item_in.old_names,			item_in.their_serial_no,			item_in.name_desc,			item_in.name_,			item_in.their_id,			item_in.decon_special_instructions,			item_in.named_by,			item_in.needs_review_notes,			item_in.vendor_tray_type,			item_in.sterilization_method,			item_in.priority,			item_in.category,			item_in.packaging_type,			item_in.packaging_notes,			item_in.their_packaging_type,			item_in.assembly_special_instructions,			item_in.sterilize_special_instructions,			item_in.label_name_abbr,			item_in.their_location,			item_in.count_sheet_status,			item_in.requested_by,			item_in.rack_row_bin_note,			item_in.standardization_status,			item_in.repair_every_x_type,			item_in.their_base_barcode,			item_in.their_key,			item_in.stuff               $BODY$LANGUAGE sql;  ALTER FUNCTION types_plus.item_to_v2 (item_in item)	OWNER TO user_bender;-- Create/recreate the CAST. Use this to convert item rows into the item_v2 compound type format using the following syntax:-- select item::item_v2 from itemDROP CAST IF EXISTS (item as item_v2);CREATE CAST (item as item_v2) WITH FUNCTION types_plus.item_to_v2(item);-- Create a function to accept an array of rows formatted as item_v2 for UPSERT into item.DROP FUNCTION IF EXISTS types_plus.insert_item_v2 (types_plus.item_v2[]);  CREATE OR REPLACE FUNCTION types_plus.insert_item_v2 (data_in types_plus.item_v2[])  RETURNS intAS $BODY$ -- The CTE below is a roundabout way of returning an insertion count from a pure SQL function in Postgres.with inserted_rows as (        INSERT INTO item (			id,			item_arch_id,			facility_specialty_id,			item_uu_id_across_item_archs,			inv_responsible_user_id,			facility_department_id,			specialty_id,			sup_id,			dr_people_id,			item_type_id,			item_master_link_id,			facility_location_id,			clinic_id,			hsys_tag_id,			name_copied_from_prod_id,			created_dts,			updated_dts,			named_dts,			needs_sched_sync_as_of_dts,			weight_lb,			qty,			flow,			flow_long,			max_processed_one_day,			par,			assembly_difficulty,			num_inst,			repair_every_x,			their_qty,			replace_every_x_cycles,			hide_specialty_in_name,			marked_for_deletion,			is_assembly_critical,			requires_leak_test,			is_not_tracked_by_inv_no,			is_imlink_locked,			is_robotic,			is_flexible_scope,			is_generic_pack,			dont_print_count_sheet,			is_conflict_check,			is_small_set,			hide_hsys_tag_in_name,			is_name_finalized,			is_in_data_cleanse_scope,			is_label_abbr,			has_implants,			sync_to_other_software_systems,			inv_has_implants,			is_custom_sort,			is_name_copied_from_prod,			is_deactivated,			is_vendor_data,			name_needs_review,			ignore_for_optimization,			inv_status,			their_name,			opt_status,			created_by,			updated_by,			old_names,			their_serial_no,			name_desc,			name_,			their_id,			decon_special_instructions,			named_by,			needs_review_notes,			vendor_tray_type,			sterilization_method,			priority,			category,			packaging_type,			packaging_notes,			their_packaging_type,			assembly_special_instructions,			sterilize_special_instructions,			label_name_abbr,			their_location,			count_sheet_status,			requested_by,			rack_row_bin_note,			standardization_status,			repair_every_x_type,			their_base_barcode,			their_key,			stuff)                  SELECT			rows_in.id,			rows_in.item_arch_id,			rows_in.facility_specialty_id,			rows_in.item_uu_id_across_item_archs,			rows_in.inv_responsible_user_id,			rows_in.facility_department_id,			rows_in.specialty_id,			rows_in.sup_id,			rows_in.dr_people_id,			rows_in.item_type_id,			rows_in.item_master_link_id,			rows_in.facility_location_id,			rows_in.clinic_id,			rows_in.hsys_tag_id,			rows_in.name_copied_from_prod_id,			rows_in.created_dts,			rows_in.updated_dts,			rows_in.named_dts,			rows_in.needs_sched_sync_as_of_dts,			rows_in.weight_lb,			rows_in.qty,			rows_in.flow,			rows_in.flow_long,			rows_in.max_processed_one_day,			rows_in.par,			rows_in.assembly_difficulty,			rows_in.num_inst,			rows_in.repair_every_x,			rows_in.their_qty,			rows_in.replace_every_x_cycles,			rows_in.hide_specialty_in_name,			rows_in.marked_for_deletion,			rows_in.is_assembly_critical,			rows_in.requires_leak_test,			rows_in.is_not_tracked_by_inv_no,			rows_in.is_imlink_locked,			rows_in.is_robotic,			rows_in.is_flexible_scope,			rows_in.is_generic_pack,			rows_in.dont_print_count_sheet,			rows_in.is_conflict_check,			rows_in.is_small_set,			rows_in.hide_hsys_tag_in_name,			rows_in.is_name_finalized,			rows_in.is_in_data_cleanse_scope,			rows_in.is_label_abbr,			rows_in.has_implants,			rows_in.sync_to_other_software_systems,			rows_in.inv_has_implants,			rows_in.is_custom_sort,			rows_in.is_name_copied_from_prod,			rows_in.is_deactivated,			rows_in.is_vendor_data,			rows_in.name_needs_review,			rows_in.ignore_for_optimization,			rows_in.inv_status,			rows_in.their_name,			rows_in.opt_status,			rows_in.created_by,			rows_in.updated_by,			rows_in.old_names,			rows_in.their_serial_no,			rows_in.name_desc,			rows_in.name_,			rows_in.their_id,			rows_in.decon_special_instructions,			rows_in.named_by,			rows_in.needs_review_notes,			rows_in.vendor_tray_type,			rows_in.sterilization_method,			rows_in.priority,			rows_in.category,			rows_in.packaging_type,			rows_in.packaging_notes,			rows_in.their_packaging_type,			rows_in.assembly_special_instructions,			rows_in.sterilize_special_instructions,			rows_in.label_name_abbr,			rows_in.their_location,			rows_in.count_sheet_status,			rows_in.requested_by,			rows_in.rack_row_bin_note,			rows_in.standardization_status,			rows_in.repair_every_x_type,			rows_in.their_base_barcode,			rows_in.their_key,			rows_in.stuff                      FROM unnest(data_in) as rows_in                  ON CONFLICT(id) DO UPDATE SET			item_arch_id = EXCLUDED.item_arch_id,			facility_specialty_id = EXCLUDED.facility_specialty_id,			item_uu_id_across_item_archs = EXCLUDED.item_uu_id_across_item_archs,			inv_responsible_user_id = EXCLUDED.inv_responsible_user_id,			facility_department_id = EXCLUDED.facility_department_id,			specialty_id = EXCLUDED.specialty_id,			sup_id = EXCLUDED.sup_id,			dr_people_id = EXCLUDED.dr_people_id,			item_type_id = EXCLUDED.item_type_id,			item_master_link_id = EXCLUDED.item_master_link_id,			facility_location_id = EXCLUDED.facility_location_id,			clinic_id = EXCLUDED.clinic_id,			hsys_tag_id = EXCLUDED.hsys_tag_id,			name_copied_from_prod_id = EXCLUDED.name_copied_from_prod_id,			created_dts = EXCLUDED.created_dts,			updated_dts = EXCLUDED.updated_dts,			named_dts = EXCLUDED.named_dts,			needs_sched_sync_as_of_dts = EXCLUDED.needs_sched_sync_as_of_dts,			weight_lb = EXCLUDED.weight_lb,			qty = EXCLUDED.qty,			flow = EXCLUDED.flow,			flow_long = EXCLUDED.flow_long,			max_processed_one_day = EXCLUDED.max_processed_one_day,			par = EXCLUDED.par,			assembly_difficulty = EXCLUDED.assembly_difficulty,			num_inst = EXCLUDED.num_inst,			repair_every_x = EXCLUDED.repair_every_x,			their_qty = EXCLUDED.their_qty,			replace_every_x_cycles = EXCLUDED.replace_every_x_cycles,			hide_specialty_in_name = EXCLUDED.hide_specialty_in_name,			marked_for_deletion = EXCLUDED.marked_for_deletion,			is_assembly_critical = EXCLUDED.is_assembly_critical,			requires_leak_test = EXCLUDED.requires_leak_test,			is_not_tracked_by_inv_no = EXCLUDED.is_not_tracked_by_inv_no,			is_imlink_locked = EXCLUDED.is_imlink_locked,			is_robotic = EXCLUDED.is_robotic,			is_flexible_scope = EXCLUDED.is_flexible_scope,			is_generic_pack = EXCLUDED.is_generic_pack,			dont_print_count_sheet = EXCLUDED.dont_print_count_sheet,			is_conflict_check = EXCLUDED.is_conflict_check,			is_small_set = EXCLUDED.is_small_set,			hide_hsys_tag_in_name = EXCLUDED.hide_hsys_tag_in_name,			is_name_finalized = EXCLUDED.is_name_finalized,			is_in_data_cleanse_scope = EXCLUDED.is_in_data_cleanse_scope,			is_label_abbr = EXCLUDED.is_label_abbr,			has_implants = EXCLUDED.has_implants,			sync_to_other_software_systems = EXCLUDED.sync_to_other_software_systems,			inv_has_implants = EXCLUDED.inv_has_implants,			is_custom_sort = EXCLUDED.is_custom_sort,			is_name_copied_from_prod = EXCLUDED.is_name_copied_from_prod,			is_deactivated = EXCLUDED.is_deactivated,			is_vendor_data = EXCLUDED.is_vendor_data,			name_needs_review = EXCLUDED.name_needs_review,			ignore_for_optimization = EXCLUDED.ignore_for_optimization,			inv_status = EXCLUDED.inv_status,			their_name = EXCLUDED.their_name,			opt_status = EXCLUDED.opt_status,			created_by = EXCLUDED.created_by,			updated_by = EXCLUDED.updated_by,			old_names = EXCLUDED.old_names,			their_serial_no = EXCLUDED.their_serial_no,			name_desc = EXCLUDED.name_desc,			name_ = EXCLUDED.name_,			their_id = EXCLUDED.their_id,			decon_special_instructions = EXCLUDED.decon_special_instructions,			named_by = EXCLUDED.named_by,			needs_review_notes = EXCLUDED.needs_review_notes,			vendor_tray_type = EXCLUDED.vendor_tray_type,			sterilization_method = EXCLUDED.sterilization_method,			priority = EXCLUDED.priority,			category = EXCLUDED.category,			packaging_type = EXCLUDED.packaging_type,			packaging_notes = EXCLUDED.packaging_notes,			their_packaging_type = EXCLUDED.their_packaging_type,			assembly_special_instructions = EXCLUDED.assembly_special_instructions,			sterilize_special_instructions = EXCLUDED.sterilize_special_instructions,			label_name_abbr = EXCLUDED.label_name_abbr,			their_location = EXCLUDED.their_location,			count_sheet_status = EXCLUDED.count_sheet_status,			requested_by = EXCLUDED.requested_by,			rack_row_bin_note = EXCLUDED.rack_row_bin_note,			standardization_status = EXCLUDED.standardization_status,			repair_every_x_type = EXCLUDED.repair_every_x_type,			their_base_barcode = EXCLUDED.their_base_barcode,			their_key = EXCLUDED.their_key,			stuff = EXCLUDED.stuff          returning 1 as row_counter)         select sum(row_counter)::integer from inserted_rows; $BODY$LANGUAGE sql;  ALTER FUNCTION types_plus.insert_item_v2(types_plus.item_v2[])	OWNER TO user_bender;