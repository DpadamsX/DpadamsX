-------------------------------------- Define table------------------------------------BEGIN;DROP TABLE IF EXISTS ascendco.facility CASCADE;CREATE TABLE IF NOT EXISTS ascendco.facility (    id                                  uuid          NOT NULL DEFAULT NULL PRIMARY KEY,    hsys_id                             uuid          NOT NULL DEFAULT NULL,	calendar_id                         uuid          NOT NULL DEFAULT '21c27277-3aa4-4396-9293-c342cc693adc'::uuid, -- Hard-coded ID of the standard US calendar definition in the calendar table.    production_label_form_id            uuid          NOT NULL DEFAULT NULL,    permanent_label_form_id             uuid          NOT NULL DEFAULT NULL,    missing_inst_label_form_id          uuid          NOT NULL DEFAULT NULL,    facility_location_label_form_id     uuid          NOT NULL DEFAULT NULL,    sterilizer_label_form_id            uuid          NOT NULL DEFAULT NULL,    user_badge_label_form_id            uuid          NOT NULL DEFAULT NULL,    workstation_label_form_id           uuid          NOT NULL DEFAULT NULL,    default_spd_facility_id             uuid          NOT NULL DEFAULT NULL,    created_dts                         timestamp     NOT NULL DEFAULT 'epoch',    updated_dts                         timestamp     NOT NULL DEFAULT 'epoch',    sonar_auto_logout_minutes           integer       NOT NULL DEFAULT 0,    sonar_auto_logout_dialog_minutes    integer       NOT NULL DEFAULT 0,    num_ors                             integer       NOT NULL DEFAULT 0,    sonar_go_live_date                  date          NOT NULL DEFAULT NULL,    marked_for_deletion                 boolean       NOT NULL DEFAULT false,    is_count_sheet_source_truth         boolean       NOT NULL DEFAULT false,    hide_doc_names_for_stats            boolean       NOT NULL DEFAULT false,    is_item_master_live                 boolean       NOT NULL DEFAULT false,    is_sonar_live                       boolean       NOT NULL DEFAULT false,    sterilizer_print_at_sterilizing     boolean       NOT NULL DEFAULT false,    sterilizer_print_at_cooling         boolean       NOT NULL DEFAULT false,    sterilizer_print_at_released        boolean       NOT NULL DEFAULT false,    can_set_all_found_in_assembly       boolean       NOT NULL DEFAULT false,    name_                               citext        NOT NULL DEFAULT NULL,    their_id                            citext        NOT NULL DEFAULT NULL,    created_by                          citext        NOT NULL DEFAULT NULL,    updated_by                          citext        NOT NULL DEFAULT NULL,    reporting_name                      citext        NOT NULL DEFAULT NULL,    label_name                          citext        NOT NULL DEFAULT NULL,    tz_name                             citext        NOT NULL DEFAULT NULL,    tz_name_pg                          citext        GENERATED ALWAYS AS (convert_ib_timezone_name(tz_name)) STORED, -- Convert IB names like "Western" to standard names, like "US/Pacific".    sonar_name_full                     citext        NOT NULL DEFAULT NULL,    sonar_count_sheet_form_name         citext        NOT NULL DEFAULT NULL,    sterilize_alert_level               citext        NOT NULL DEFAULT NULL,    sonar_scanner_stop_char             citext        NOT NULL DEFAULT NULL,    emr_location_name                   citext        NOT NULL DEFAULT NULL,    sonar_features                      jsonb         NOT NULL DEFAULT '{}'::jsonb,    interfaces                          jsonb         NOT NULL DEFAULT '{}'::jsonb,    needs_scheduling                    jsonb         NOT NULL DEFAULT '{}'::jsonb,    analytics_prefs                     jsonb         NOT NULL DEFAULT '{}'::jsonb);ALTER TABLE ascendco.facility	OWNER TO user_change_structure;-------------------------------------- Build statistics------------------------------------/*The Postgres ANALYZE system function collects statistics about each table and column. These valuesare used by the query planner to help generate probabilistic cost estimates for various query plans.When the plans are based on misleading stats, you can have poor performance. Stats can be reconfiguredon a row-by-row basis, and some special extended statistics are supported too.Custom and extended statistics are typically added after we've been accumulating data for some time.See PgBuildStatistics_Extended in IB to declare new statistics objects. For more background, seehttps://ascendco.atlassian.net/wiki/spaces/SON/pages/1723695105/*/-------------------------------------- ANALYZE options-------------------------------------- Placholder and reminder for now. ANALYZE and AUTOVACUUM tunings are *core* Postgres DBA-- skills. But, for the minute, we're not running into trouble. I'm chipping away af figuring-- out when to tune, and how, and when not to tune. ‚Äî DPA-------------------------------------- Build indexes-------------------------------------- Note: Postgres automatically creates a UNIQUE B-tree for the PRIMARY KEY, simple or compound./* Indexing trade-offs are different in 4D and Postgres.It pays to be a bit conservative about adding indexes in Postgres, wait and see what you need.CREATE INDEX facility_hsys_id_ix_gin          ON ascendco.facility       USING GIN (hsys_id);CREATE INDEX facility_marked_for_deletion_ix_gin          ON ascendco.facility       USING GIN (marked_for_deletion extensions.bool_ops)       WHERE marked_for_deletion = true;*/-------------------------------------- CLUSTER------------------------------------/*Code stub/reminder about CLUSTERing. Not a hard topic, but too big to write up here. Notes and links:https://ascendco.atlassian.net/wiki/spaces/SON/pages/356679683/ALTER TABLE ascendco.facility    CLUSTER ON ***index name to cluster by here.***;*/-------------------------------------- Add triggers------------------------------------   CREATE TRIGGER trigger_facility_after_delete            AFTER DELETE               ON ascendco.facility      REFERENCING OLD TABLE AS deleted_rows         FOR EACH STATEMENTEXECUTE PROCEDURE ascendco.trigger_function_log_deletion_count();  CREATE TRIGGER trigger_facility_before_truncate            BEFORE TRUNCATE               ON ascendco.facility         FOR EACH STATEMENTEXECUTE PROCEDURE ascendco.trigger_function_log_truncation_count();-------------------------------------- Manual Permissions for now-------------------------------------- Standard permissions for utility/admin users:GRANT SELECT, INSERT, UPDATE, DELETE ON ascendco.facility TO rds_super;GRANT SELECT, INSERT, UPDATE, DELETE ON ascendco.facility TO user_cleanup;GRANT SELECT, INSERT, UPDATE, DELETE ON ascendco.facility TO user_change_structure;GRANT SELECT ON ascendco.facility TO user_reporting;-- Adjustable user permissions:GRANT SELECT ON ascendco.facility TO user_iceberg;GRANT SELECT ON ascendco.facility TO user_iceberg_remote;GRANT SELECT ON ascendco.facility TO user_saws;GRANT SELECT ON ascendco.facility TO user_sonar;GRANT SELECT, INSERT, UPDATE, DELETE ON ascendco.facility TO user_leviathan;COMMIT;